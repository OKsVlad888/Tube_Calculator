import math
import streamlit as st

# ×”×’×“×¨×ª ×¤×¨×˜×™ ×”×¢××•×“ (×›×•×ª×¨×ª ×•×¡××œ) ×•×¤×¨×™×¡×” ××¨×›×–×™×ª. 
# (× ×™×ª×Ÿ ×œ×©× ×•×ª ××ª ×¢×¨×›×ª ×”× ×•×©× ×œ×§×”×” ×“×¨×š ×§×•×‘×¥ config.toml ×”××¤×•×¨×˜ ×‘×”××©×š)
st.set_page_config(page_title="××—×©×‘×•×Ÿ ×–×¨×™××ª ×’×– ×‘×œ×—×¥ ×’×‘×•×” (Darcyâ€“Weisbach)",
                   page_icon="ğŸ’¨", layout="centered")

# ×”×’×“×¨×ª × ×ª×•× ×™ ×”×’×–×™×: ××©×§×œ ××•×œ×§×•×œ×¨×™ [×§\"×’/××•×œ] ×¢×‘×•×¨ ×›×œ ×¡×•×’ ×’×–
GAS_DATA = {
    "N2": 0.028013,
    "O2": 0.031999,
    "Ar": 0.039948,
    "CO2": 0.04401,
    "He": 0.0040026,
    "H2": 0.002016,
    "CH4": 0.01604,
    "C2H2": 0.02604,
    "Forming Gas 1": 0.0380,
    "Forming Gas 2": 0.0387
}

# ×¨×©×™××ª ×¡×•×’×™ ×”×’×–×™× ×œ×ª×¤×¨×™×˜ ×”×‘×—×™×¨×”
GAS_LIST = list(GAS_DATA.keys())

# ××™×¤×•×™ ×¡×•×’×™ ×”×—×™×©×•×‘ ×œ×©×“×•×ª ×”×§×œ×˜ ×”× ×“×¨×©×™× ×¢×‘×•×¨ ×›×œ ×¡×•×’ (××—×¨×•×–×•×ª ×œ×ª×¦×•×’×” ×œ××©×ª××©)
CALC_FIELDS = {
    "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)": ["×˜××¤×¨×˜×•×¨×” (Â°C)", "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)", "×œ×—×¥ ×™×¦×™××” (×‘×¨)", "××•×¨×š ×¦×™× ×•×¨ (×')", "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)"],
    "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)": ["×˜××¤×¨×˜×•×¨×” (Â°C)", "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)", "×œ×—×¥ ×™×¦×™××” (×‘×¨)", "××•×¨×š ×¦×™× ×•×¨ (×')", "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)"],
    "××•×¨×š ×¦×™× ×•×¨ (×')": ["×˜××¤×¨×˜×•×¨×” (Â°C)", "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)", "×œ×—×¥ ×™×¦×™××” (×‘×¨)", "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)", "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)"],
    "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)": ["×˜××¤×¨×˜×•×¨×” (Â°C)", "×œ×—×¥ ×™×¦×™××” (×‘×¨)", "××•×¨×š ×¦×™× ×•×¨ (×')", "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)", "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)"],
    "×œ×—×¥ ×™×¦×™××” (×‘×¨)": ["×˜××¤×¨×˜×•×¨×” (Â°C)", "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)", "××•×¨×š ×¦×™× ×•×¨ (×')", "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)", "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)"]
}

def ideal_gas_density(P_pa, T_k, gas_type):
    """××—×–×™×¨×” ×¦×¤×™×¤×•×ª ×”×’×– [×§\"×’/×^3] ×‘×œ×—×¥ P (×‘×¤×¡×§×œ) ×•×˜××¤×¨×˜×•×¨×” T (×‘×§×œ×•×•×™×Ÿ) ×œ×¤×™ ×—×•×§ ×”×’×– ×”××™×“×™××œ×™."""
    R = 8.314  # ×§×‘×•×¢ ×”×’×–×™× [J/(mol*K)]
    M = GAS_DATA.get(gas_type)
    if M is None:
        # ×× ×¡×•×’ ×”×’×– ××™× ×• ××•×›×¨, ××•×¤×§×ª ×©×’×™××”
        raise ValueError(f"×œ× × ××¦××• × ×ª×•× ×™ ×’×– ×¢×‘×•×¨ ×¡×•×’: {gas_type}")
    return (P_pa * M) / (R * T_k)

def calc_required_diameter(P_in_bar, P_out_bar, T_c, L_m, Q_lpm, gas_type, f=0.02):
    """×—×™×©×•×‘ ×§×•×˜×¨ ×¤× ×™××™ ×“×¨×•×© [×\"×] ×œ×¤×™ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š ×œ× ×ª×•× ×™ ×”×–×¨×™××” ×”× ×ª×•× ×™×."""
    # ×”××¨×ª ×™×—×™×“×•×ª ×œ-SI
    P_in_pa = P_in_bar * 100000      # ×‘×¨ -> ×¤×¡×§×œ
    P_out_pa = P_out_bar * 100000    # ×‘×¨ -> ×¤×¡×§×œ
    T_k = T_c + 273.15               # ×¦×œ×–×™×•×¡ -> ×§×œ×•×•×™×Ÿ
    Q_m3_s = Q_lpm / 1000.0 / 60.0   # ×œ×™×˜×¨/×“×§×” -> ×\"×§/×©× ×™×™×”
    # ×—×™×©×•×‘ ×¦×¤×™×¤×•×ª ×”×’×– ×‘×ª×—×™×œ×ª ×•×‘×¡×•×£ ×”×¦×™× ×•×¨, ×•×”×¦×¤×™×¤×•×ª ×”×××•×¦×¢×ª:
    rho_in = ideal_gas_density(P_in_pa, T_k, gas_type)
    rho_out = ideal_gas_density(P_out_pa, T_k, gas_type)
    rho_avg = (rho_in + rho_out) / 2.0
    # ×”×¤×¨×© ×œ×—×¦×™× (×¤×¡×§×œ)
    delta_p = P_in_pa - P_out_pa
    if delta_p <= 0:
        raise ValueError("×œ×—×¥ ×›× ×™×¡×” ×—×™×™×‘ ×œ×”×™×•×ª ×’×‘×•×” ××œ×—×¥ ×™×¦×™××” ×‘×›×“×™ ×©×ª×ª×¨×—×© ×–×¨×™××”.")
    # ×¤×ª×¨×•×Ÿ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š ×¢×‘×•×¨ D (×‘××˜×¨×™×) -> ×”××¨×” ×œ×\"×
    D_m = ((f * L_m * 8.0 * rho_avg * (Q_m3_s ** 2)) / ((math.pi ** 2) * delta_p)) ** 0.2
    return D_m * 1000.0  # ×ª×•×¦××” ×‘××™×œ×™××˜×¨×™×

def calc_flow_rate(P_in_bar, P_out_bar, T_c, L_m, D_mm, gas_type, f=0.02):
    """×—×™×©×•×‘ ×¡×¤×™×§×” ××™×¨×‘×™×ª [×œ×™×˜×¨/×“×§×”] ×‘×¦×™× ×•×¨ × ×ª×•×Ÿ ×œ×¤×™ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š."""
    P_in_pa = P_in_bar * 100000
    P_out_pa = P_out_bar * 100000
    T_k = T_c + 273.15
    D_m = D_mm / 1000.0  # ×”××¨×ª ×§×•×˜×¨ ×¤× ×™××™ ××\"× -> ××˜×¨
    rho_in = ideal_gas_density(P_in_pa, T_k, gas_type)
    rho_out = ideal_gas_density(P_out_pa, T_k, gas_type)
    rho_avg = (rho_in + rho_out) / 2.0
    delta_p = P_in_pa - P_out_pa
    if delta_p <= 0:
        raise ValueError("×œ×—×¥ ×›× ×™×¡×” ×—×™×™×‘ ×œ×”×™×•×ª ×’×‘×•×” ××œ×—×¥ ×™×¦×™××” ×œ×¦×•×¨×š ×—×™×©×•×‘ ×¡×¤×™×§×”.")
    # ×¤×ª×¨×•×Ÿ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š ×œ××¦×™××ª ×”×¡×¤×™×§×” (×\"×§/×©× ×™×™×”) -> ×”××¨×” ×œ×œ×™×˜×¨/×“×§×”
    Q_m3_s = math.sqrt((delta_p * (math.pi ** 2) * (D_m ** 5)) / (8.0 * f * L_m * rho_avg))
    return Q_m3_s * 1000.0 * 60.0  # ×ª×•×¦××” ×‘×œ×™×˜×¨/×“×§×”

def calc_max_length(P_in_bar, P_out_bar, T_c, D_mm, Q_lpm, gas_type, f=0.02):
    """×—×™×©×•×‘ ××•×¨×š ×¦×™× ×•×¨ ××§×¡×™××œ×™ [×'] ×œ×¤×™ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š ×œ× ×ª×•× ×™ ×”×–×¨×™××” ×”× ×ª×•× ×™×."""
    P_in_pa = P_in_bar * 100000
    P_out_pa = P_out_bar * 100000
    T_k = T_c + 273.15
    D_m = D_mm / 1000.0
    rho_in = ideal_gas_density(P_in_pa, T_k, gas_type)
    rho_out = ideal_gas_density(P_out_pa, T_k, gas_type)
    rho_avg = (rho_in + rho_out) / 2.0
    delta_p = P_in_pa - P_out_pa
    if delta_p <= 0:
        raise ValueError("×œ×—×¥ ×›× ×™×¡×” ×¦×¨×™×š ×œ×”×™×•×ª ×’×‘×•×” ××œ×—×¥ ×™×¦×™××” ×›×“×™ ×©×ª×”×™×” ×–×¨×™××”.")
    Q_m3_s = Q_lpm / 1000.0 / 60.0  # ×œ×™×˜×¨/×“×§×” -> ×\"×§/×©× ×™×™×”
    # ×¤×ª×¨×•×Ÿ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š ×¢×‘×•×¨ L (××˜×¨×™×)
    L_m = (delta_p * (math.pi ** 2) * (D_m ** 5)) / (8.0 * f * rho_avg * (Q_m3_s ** 2))
    return L_m  # ××•×¨×š ××§×¡×™××œ×™ ×‘××˜×¨×™×

def calc_outlet_pressure(P_in_bar, T_c, L_m, D_mm, Q_lpm, gas_type, f=0.02):
    """×××™×“×ª ×œ×—×¥ ×™×¦×™××” [×‘×¨] ×¢×œ ×¤×™ ××©×•×•××ª ×“××¨×¡×™â€“×•×™×™×¡×‘××š (×‘×××¦×¢×•×ª ××™×˜×¨×¦×™×”)."""
    P_in_pa = P_in_bar * 100000
    T_k = T_c + 273.15
    D_m = D_mm / 1000.0
    Q_m3_s = Q_lpm / 1000.0 / 60.0
    # × × ×™×— ×”×ª×—×œ×” ×©×œ ×œ×—×¥ ×™×¦×™××” ×©×•×•×” ×œ×œ×—×¥ ×›× ×™×¡×”, ×•× ×‘×¦×¢ ××™×˜×¨×¦×™×” ×œ×”×ª×›× ×¡×•×ª
    P_out_guess_bar = P_in_bar
    for _ in range(20):
        P_out_pa = P_out_guess_bar * 100000
        rho_in = ideal_gas_density(P_in_pa, T_k, gas_type)
        rho_out = ideal_gas_density(P_out_pa, T_k, gas_type)
        rho_avg = (rho_in + rho_out) / 2.0
        # ×—×™×©×•×‘ ×™×¨×™×“×ª ×”×œ×—×¥ ×œ×¤×™ ×”×”×©×¢×¨×” ×”× ×•×›×—×™×ª
        delta_p_calc = (8.0 * f * L_m * rho_avg * (Q_m3_s ** 2)) / ((math.pi ** 2) * (D_m ** 5))
        P_out_calc_bar = P_in_bar - (delta_p_calc / 100000)  # ×œ×—×¥ ×”×™×¦×™××” ×”××—×•×©×‘ ×œ×¤×™ ×”×”×©×¢×¨×”
        if abs(P_out_calc_bar - P_out_guess_bar) < 0.001:  # ×‘×“×™×§×” ×× ×”×ª×•×¦××” ×”×ª×›× ×¡×”
            return max(P_out_calc_bar, 0.0)
        P_out_guess_bar = P_out_calc_bar
    # ×‘××§×¨×” ×©×”×œ×•×œ××” ×œ× ×”×ª×›× ×¡×” ×‘×“×™×•×§ ×œ××—×¨ 20 ××™×˜×¨×¦×™×•×ª, × ×—×–×™×¨ ××ª ×”×¢×¨×š ×”××—×¨×•×Ÿ ×”××§×¡×™××œ×™ ×¢× 0
    return max(P_out_guess_bar, 0.0)

def calc_required_inlet_pressure(P_out_bar, T_c, L_m, D_mm, Q_lpm, gas_type, f=0.02):
    """×—×™×©×•×‘ ×œ×—×¥ ×›× ×™×¡×” ×“×¨×•×© [×‘×¨] ×œ×”×©×’×ª ×œ×—×¥ ×™×¦×™××” ×™×¢×“ × ×ª×•×Ÿ (×¤×ª×¨×•×Ÿ × ×•××¨×™ ××™×˜×¨×˜×™×‘×™)."""
    # × ×’×“×™×¨ ×ª×—×•× ×¨××©×•× ×™ ×œ×—×™×¤×•×© ×”×œ×—×¥ ×”×“×¨×•×©: ×‘×™×Ÿ ×œ×—×¥ ×”×™×¦×™××” ×”× ×“×¨×© ×œ×‘×™×Ÿ ×¢×¨×š ×’×‘×•×” ×™×•×ª×¨ 
    P_low = P_out_bar
    P_high = P_out_bar + 100.0
    # × ×—×¤×© ×’×‘×•×œ ×¢×œ×™×•×Ÿ ×©×‘×• ×œ×—×¥ ×”×™×¦×™××” ×”××—×•×©×‘ × ××•×š ××¡×¤×™×§ (××• ×¢×“ ×’×‘×•×œ ××§×¡×™××œ×™)
    while True:
        P_out_test = calc_outlet_pressure(P_high, T_c, L_m, D_mm, Q_lpm, gas_type, f)
        if P_out_test <= P_out_bar or P_high >= P_out_bar + 2000:
            break
        P_high += 100.0
    # ×œ××—×¨ ××¦×™××ª ×’×‘×•×œ×•×ª, × ×‘×¦×¢ ×—×™×¤×•×© ×‘×™× ××¨×™ ×œ×”×ª×›× ×¡×•×ª ×œ×œ×—×¥ ×”× ×“×¨×©
    for _ in range(50):
        P_mid = (P_low + P_high) / 2.0
        P_out_mid = calc_outlet_pressure(P_mid, T_c, L_m, D_mm, Q_lpm, gas_type, f)
        if abs(P_out_mid - P_out_bar) < 0.01:
            return P_mid
        if P_out_mid > P_out_bar:
            # ×”×œ×—×¥ ×”× ×“×¨×© ×¢×“×™×™×Ÿ ×’×‘×•×” ××“×™ â€“ × ×•×¨×™×“ ××ª ×”×’×‘×•×œ ×”×¢×œ×™×•×Ÿ
            P_low = P_mid
        else:
            # ×”×œ×—×¥ ×”× ×“×¨×© × ××•×š ××“×™ â€“ × ×¨×™× ××ª ×”×’×‘×•×œ ×”×ª×—×ª×•×Ÿ
            P_high = P_mid
    # ×× ××—×¨×™ 50 ××™×˜×¨×¦×™×•×ª ×œ× ×”×’×¢× ×• ×œ××“×•×™×§, × ×—×–×™×¨ ××ª × ×§×•×“×ª ×”×××¦×¢ ×›×§×™×¨×•×‘ ×¡×•×¤×™
    return (P_low + P_high) / 2.0

def recommend_pipe(D_mm, P_bar):
    """×”××œ×¦×” ×¢×œ ×¦×™× ×•×¨ ××ª××™× ×œ×¤×™ ×§×•×˜×¨ ×¤× ×™××™ ××—×•×©×‘ [×\"×] ×•×œ×—×¥ ×¢×‘×•×“×” (×‘×”×ª×× ×œ××¤×¨×˜×™ S6/S9/S12/S14/S15/S16)."""
    # ×¡×™×•×•×’ ×”×¦×™× ×•×¨ ×œ×¤×™ ×§×•×˜×¨ ×¤× ×™××™
    if D_mm <= 4.0:
        # ×¢×‘×•×¨ ×§×•×˜×¨ ~×¢×“ 4 ×\"× (×›-1/4 ××™× ×¥\'):
        if P_bar <= 200:
            return "×¦×™× ×•×¨ 1/4 ××™× ×¥' (××¤×¨×˜ S6)"
        elif P_bar <= 1379:  # 1379 ×‘×¨ â‰ˆ 20,000 PSI
            return "×¦×™× ×•×¨ 1/4 ××™× ×¥' (××¤×¨×˜ S9)"
        else:
            return "×¦×™× ×•×¨ 1/4 ××™× ×¥' (××¤×¨×˜ S12)"
    elif D_mm <= 7.0:
        # ×¢×‘×•×¨ ×§×•×˜×¨ ~×¢×“ 7 ×\"× (×›-3/8Â ××™× ×¥\'):
        if P_bar <= 140:
            return "×¦×™× ×•×¨ 3/8 ××™× ×¥' (××¤×¨×˜ S16)"
        else:
            return "×¦×™× ×•×¨ 3/8 ××™× ×¥' (××¤×¨×˜ S9)"
    elif D_mm <= 21.0:
        # ×¢×‘×•×¨ ×§×•×˜×¨ ~×¢×“ 21 ×\"× (×›-3/4Â ××™× ×¥\'â€“1Â ××™× ×¥\'):
        if P_bar <= 20:
            return "×¦×™× ×•×¨ 3/4 ××™× ×¥' (××¤×¨×˜ S15)"
        else:
            return "×¦×™× ×•×¨ 1 ××™× ×¥' (××¤×¨×˜ S14)"
    else:
        # ×§×•×˜×¨ ×’×“×•×œ ××”×ª×§× ×™× ×”×¨×’×™×œ×™×
        return "×¦× ×¨×ª ××™×•×—×“×ª (××—×•×¥ ×œ×˜×•×•×— ×”×ª×§×Ÿ)"

# --- ×”×ª×—×œ×ª ×××©×§ ×”××©×ª××© (UI) ×‘××¤×œ×™×§×¦×™×™×ª Streamlit ---

# ×›×•×ª×¨×ª ×¢×œ×™×•× ×” ×œ××¤×œ×™×§×¦×™×”
st.title("××—×©×‘×•×Ÿ ×–×¨×™××ª ×’×– ×‘×œ×—×¥ ×’×‘×•×” â€“ Darcyâ€“Weisbach")

# ×”×¡×‘×¨ ×§×¦×¨ ×‘×¨××© ×”×“×£ (××•×¤×¦×™×•× ×œ×™)
st.markdown("××¤×œ×™×§×¦×™×” ×œ×—×™×©×•×‘×™ ×§×•×˜×¨ ×¦×™× ×•×¨, ×¡×¤×™×§×”, ××•×¨×š ×•×œ×—×¦×™× ×¢×‘×•×¨ ×–×¨×™××ª ×’×– ×‘×œ×—×¥ ×’×‘×•×”, ×‘×”×ª×‘×¡×¡ ×¢×œ ××©×•×•××ª **×“××¨×¡×™â€“×•×™×™×¡×‘××š**. ×‘×—×¨×• **×¡×•×’ ×’×–** ×•×¡×•×’ ×—×™×©×•×‘, ×”×–×™× ×• ××ª × ×ª×•× ×™ ×”×ª×”×œ×™×š, ×•×œ×—×¦×• ×¢×œ **×—×©×‘** ×œ×§×‘×œ×ª ×ª×•×¦××” ×•×”××œ×¦×ª ×¦× ×¨×ª ××ª××™××”.")

# ×‘×—×™×¨×ª ×¡×•×’ ×”×’×– ×•×¡×•×’ ×”×—×™×©×•×‘ (×ª×¤×¨×™×˜×™× × ×¤×ª×—×™×)
gas_type = st.selectbox("×¡×•×’ ×”×’×–:", options=GAS_LIST, index=0)
calc_type = st.selectbox("×¡×•×’ ×”×—×™×©×•×‘:", options=list(CALC_FIELDS.keys()), index=0)

# ×”×¦×’×ª ×©×“×•×ª ×”×§×œ×˜ ×‘×”×ª×× ×œ×¡×•×’ ×”×—×™×©×•×‘ ×”× ×‘×—×¨
input_values = {}
fields = CALC_FIELDS.get(calc_type, [])
for field in fields:
    # ×™×¦×™×¨×ª ×©×“×” ×§×œ×˜ ××¡×¤×¨×™ (×¢× ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×¡×‘×™×¨×™× ×›×“×™ ×œ×¡×™×™×¢ ×œ××©×ª××©)
    if "×˜××¤×¨×˜×•×¨×”" in field:
        input_values[field] = st.number_input(field, value=25.0, step=1.0, format="%.2f")
    elif "×œ×—×¥ ×›× ×™×¡×”" in field:
        input_values[field] = st.number_input(field, value=100.0, step=1.0, format="%.2f")
    elif "×œ×—×¥ ×™×¦×™××”" in field:
        input_values[field] = st.number_input(field, value=10.0, step=1.0, format="%.2f")
    elif "××•×¨×š ×¦×™× ×•×¨" in field:
        input_values[field] = st.number_input(field, value=10.0, step=1.0, format="%.2f")
    elif "×§×•×˜×¨ ×¦×™× ×•×¨" in field:
        input_values[field] = st.number_input(field, value=10.0, step=0.1, format="%.2f")
    elif "×¡×¤×™×§×”" in field:
        input_values[field] = st.number_input(field, value=100.0, step=1.0, format="%.2f")
    else:
        # ×©×“×” ×›×œ×œ×™ (fallback) ×× ×™×•×¤×™×¢ (×œ× ×¦×¤×•×™ ×‘××™×¤×•×™ ×”× ×•×›×—×™)
        input_values[field] = st.number_input(field, value=0.0, step=1.0, format="%.2f")

# ×©×“×” ×œ×”×–× ×ª ××§×“× ×—×™×›×•×š f (×¢× ×¢×¨×š ×‘×¨×™×¨×ª ××—×“×œ 0.02)
f_value = st.number_input("××§×“× ×—×™×›×•×š f:", value=0.02, step=0.005, format="%.3f")

# × ×™×”×•×œ ××¦×‘ (session state) ×œ×©××™×¨×ª ×”×ª×•×¦××” ×”××—×¨×•× ×”, ×›×“×™ ×©×ª×•×¦×’ ×¢×“ ×©×™× ×•×™ ×”×‘× 
if "last_result" not in st.session_state:
    st.session_state.last_result = None
    st.session_state.last_is_error = False

# ×›×¤×ª×•×¨ ×—×™×©×•×‘ - ×œ×•×—×¦×™× ×›×“×™ ×œ×‘×¦×¢ ××ª ×”×—×™×©×•×‘
if st.button("×—×©×‘"):
    try:
        # ×§×¨×™××ª ×”×¢×¨×›×™× ××”×§×œ×˜ ×œ××©×ª× ×™× ×œ×¤×™ ×¡×•×’ ×”×—×™×©×•×‘
        T_c = float(input_values.get("×˜××¤×¨×˜×•×¨×” (Â°C)", 0.0))
        P_in = float(input_values.get("×œ×—×¥ ×›× ×™×¡×” (×‘×¨)", 0.0))
        P_out = float(input_values.get("×œ×—×¥ ×™×¦×™××” (×‘×¨)", 0.0))
        L_m = float(input_values.get("××•×¨×š ×¦×™× ×•×¨ (×')", 0.0))
        D_mm = float(input_values.get("×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)", 0.0))
        Q_lpm = float(input_values.get("×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)", 0.0))
        # ×‘×”×ª×× ×œ×¡×•×’ ×”×—×™×©×•×‘, × ×‘×¦×¢ ××ª ×”×¤×•× ×§×¦×™×” ×”××ª××™××”:
        if calc_type == "×§×•×˜×¨ ×¦×™× ×•×¨ (×\"×)":
            D_required = calc_required_diameter(P_in, P_out, T_c, L_m, Q_lpm, gas_type, f=f_value)
            # ×œ×—×¥ ×”×¢×‘×•×“×” (×”×’×‘×•×” ××‘×™×Ÿ ×›× ×™×¡×”/×™×¦×™××”) ×œ×§×‘×™×¢×ª ××¤×¨×˜ ×”×¦×™× ×•×¨
            P_work = max(P_in, P_out)
            pipe_rec = recommend_pipe(D_required, P_work)
            result_text = f"**×”×§×•×˜×¨ ×”×¤× ×™××™ ×”× ×“×¨×©:** {D_required:.2f} ×\"×  \n**×”×¦×™× ×•×¨ ×”××•××œ×¥:** {pipe_rec}."
        elif calc_type == "×¡×¤×™×§×” (×œ×™×˜×¨/×“×§×”)":
            Q_max = calc_flow_rate(P_in, P_out, T_c, L_m, D_mm, gas_type, f=f_value)
            P_work = max(P_in, P_out)
            pipe_rec = recommend_pipe(D_mm, P_work)
            result_text = f"**×¡×¤×™×§×” ××™×¨×‘×™×ª ×‘×¦×™× ×•×¨:** {Q_max:.1f} ×œ×™×˜×¨/×“×§×”  \n**×¦×™× ×•×¨ ××ª××™×:** {pipe_rec}."
        elif calc_type == "××•×¨×š ×¦×™× ×•×¨ (×')":
            L_max = calc_max_length(P_in, P_out, T_c, D_mm, Q_lpm, gas_type, f=f_value)
            P_work = max(P_in, P_out)
            pipe_rec = recommend_pipe(D_mm, P_work)
            result_text = f"**××•×¨×š ×¦×™× ×•×¨ ××§×¡×™××œ×™:** {L_max:.1f} ×'  \n**×¦×™× ×•×¨ ××ª××™×:** {pipe_rec}."
        elif calc_type == "×œ×—×¥ ×›× ×™×¡×” (×‘×¨)":
            P_in_required = calc_required_inlet_pressure(P_out, T_c, L_m, D_mm, Q_lpm, gas_type, f=f_value)
            pipe_rec = recommend_pipe(D_mm, P_in_required)
            result_text = f"**×œ×—×¥ ×›× ×™×¡×” ×“×¨×•×©:** {P_in_required:.2f} ×‘×¨  \n**×¦×™× ×•×¨ ××•××œ×¥:** {pipe_rec}."
        elif calc_type == "×œ×—×¥ ×™×¦×™××” (×‘×¨)":
            P_out_calc = calc_outlet_pressure(P_in, T_c, L_m, D_mm, Q_lpm, gas_type, f=f_value)
            pipe_rec = recommend_pipe(D_mm, P_in)  # ×œ×—×¥ ×”×¢×‘×•×“×” ×”×•× ×œ×—×¥ ×”×›× ×™×¡×” ×‘××§×¨×” ×–×”
            result_text = f"**×œ×—×¥ ×™×¦×™××” ××©×•×¢×¨:** {P_out_calc:.2f} ×‘×¨  \n**×¦×™× ×•×¨ ××ª××™×:** {pipe_rec}."
        else:
            result_text = "×©×’×™××”: ×¡×•×’ ×—×™×©×•×‘ ×œ× × ×ª××š."
        # ×©××™×¨×ª ×”×ª×•×¦××” ×‘××¦×‘ ×¢×‘×•×¨ ×”×¦×’×” ××ª××©×›×ª
        st.session_state.last_result = result_text
        st.session_state.last_is_error = False
    except Exception as e:
        # ×‘××§×¨×” ×©×œ ×©×’×™××” (×œ××©×œ ×¢×¨×š ×©×’×•×™ ××• ××™ ×¢××™×“×” ×‘×“×¨×™×©×•×ª ×”×¤×•× ×§×¦×™×•×ª)
        st.session_state.last_result = f"×©×’×™××” ×‘×—×™×©×•×‘: {e}"
        st.session_state.last_is_error = True

# ×”×¦×’×ª ×”×ª×•×¦××” ××• ×”×•×“×¢×ª ×”×©×’×™××”, ×× ×§×™×™××ª ×ª×•×¦××” ××—×¨×•× ×” ××—×™×©×•×‘
if st.session_state.last_result is not None:
    if st.session_state.last_is_error:
        st.error(st.session_state.last_result)
    else:
        st.success(st.session_state.last_result)